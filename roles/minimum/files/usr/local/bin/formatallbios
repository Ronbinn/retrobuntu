#!/bin/bash
if [ $# -eq 0 ]
  then
    echo "You have to choose a disk"
    lsblk | grep disk
    exit
fi
for n in /dev/$1* ; do umount $n ; done
swapoff --all

p=""

if [[ $1 = nvme* || $1 = mmc* ]]
  then
    p="p"
fi

#create partition table
dd if=/dev/zero of=/dev/$1 bs=10240 count=1
parted -s /dev/$1 mklabel gpt  \
 mkpart primary ext4 0% 20GB  \
 mkpart primary linux-swap 20GB 24GB  \
 mkpart primary ext4 24GB 100%  \
 set 1 legacy_boot on
sync

#format partitions
mkfs.ext4 /dev/${1}${p}1 -FL system
mkswap /dev/${1}${p}2
mkfs.ext4 /dev/${1}${p}3 -FL home

#get UUIDs
uuid1=`blkid -s UUID -o value /dev/${1}${p}1`
uuid2=`blkid -s UUID -o value /dev/${1}${p}2`
uuid3=`blkid -s UUID -o value /dev/${1}${p}3`

#install and configure syslinux
dd bs=440 count=1 conv=notrunc if=/usr/lib/syslinux/mbr/gptmbr.bin of=/dev/$1
mkdir sda1
mount /dev/${1}${p}1 sda1
extlinux --install sda1/
cp /root/syslinux_local.cfg sda1/syslinux.cfg
cp /boot/ipxe.lkrn sda1/
cp /usr/lib/syslinux/modules/bios/libutil.c32 sda1/
cp /usr/lib/syslinux/modules/bios/menu.c32 sda1/
cp /usr/lib/syslinux/modules/bios/ldlinux.c32 sda1/

#install system
echo "copying the image..."
pv /lib/live/mount/medium/live/filesystem.squashfs > sda1/filesystem.squashfs
cd sda1
echo "installing on disk..."
unsquashfs filesystem.squashfs
cd ..
mv sda1/squashfs-root/* sda1/
rmdir sda1/squashfs-root
rm sda1/filesystem.squashfs

#generate fstab
echo "updating fstab..."
echo "UUID=$uuid1    /                   ext4    defaults                0 0" >> sda1/etc/fstab
echo "UUID=$uuid2    swap        swap    defaults                0 0" >> sda1/etc/fstab
echo "UUID=$uuid3    /home       ext4    defaults                0 0" >> sda1/etc/fstab

#get kernel and initrd
echo "copying kernel and initrd"
if test -f "sda1/boot/initrd.img"; then
    cp sda1/boot/initrd.img sda1/ 
    cp sda1/boot/vmlinuz sda1/
fi
echo "removing unmute"
if test -f "sda1/etc/xdg/autostart/unmute.desktop"; then
    rm sda1/etc/xdg/autostart/unmute.desktop
fi
echo "restoring NetworkManager"
if test -f "sda1/usr/share/applications/nm-applet.desktop"; then
    cp sda1/usr/share/applications/nm-applet.desktop sda1/etc/xdg/autostart/nm-applet.desktop
fi
echo "disabling dchlient service"
if test -f "/etc/systemd/system/multi-user.target.wants/dhclient.service"; then
    rm /etc/systemd/system/multi-user.target.wants/dhclient.service
fi
echo "disabling swapiness service"
if test -f "/etc/systemd/system/multi-user.target.wants/swapiness.service"; then
    rm /etc/systemd/system/multi-user.target.wants/swapiness.service
fi
sed -i.bak 's,sda2,'"UUID=$uuid1"',g' sda1/syslinux.cfg
umount /dev/${1}${p}1
rmdir sda1
